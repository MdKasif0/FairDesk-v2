rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the request is from an authenticated user.
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to get the requesting user's document from the `users` collection.
    function getRequestingUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // Helper function to check if the requesting user belongs to a specific group.
    function isMemberOfGroup(groupId) {
      return isSignedIn() && getRequestingUserDoc().data.groupId == groupId;
    }

    // `users` collection rules
    match /users/{userId} {
      // A user can create their own user document.
      allow create: if isSignedIn() && request.auth.uid == userId;
      // A user can read or update their own user document.
      allow read, update: if isSignedIn() && request.auth.uid == userId;
    }
    
    // `groups` collection rules
    match /groups/{groupId} {
      // A user can create a group if their uid is the creatorId in the new document.
      allow create: if isSignedIn() && request.resource.data.creatorId == request.auth.uid;

      // Any member of the group can read the group document.
      allow read: if isMemberOfGroup(groupId);
      
      // An existing member can update the group.
      // A non-member can update the group ONLY to add themselves to the members list,
      // provided the group is not locked.
      allow update: if isMemberOfGroup(groupId) || 
                     (isSignedIn() && 
                      request.resource.data.members == resource.data.members.concat([request.auth.uid]) && 
                      resource.data.isLocked == false);
    }

    // All other group-related collections (seats, assignments, changeRequests)
    match /{collection}/{docId} {
      // Any member can perform any action (read, list, write) on documents
      // within these collections, as long as the document's groupId matches their own.
      allow read, list, write: if isSignedIn() &&
                                (collection == 'seats' || collection == 'assignments' || collection == 'changeRequests') &&
                                isMemberOfGroup(request.resource.data.groupId);
    }
  }
}
